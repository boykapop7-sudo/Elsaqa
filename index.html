<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§ÙˆÙŠØ± ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚Ø§</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; color:#222; }
header { background:#007bff; color:white; padding:10px; text-align:center; font-size:20px; position:relative; }
#date { font-size:14px; margin-top:5px; opacity:.9 }
.container { padding:15px; max-width:900px; margin:0 auto; }
input { display:block; width:100%; padding:10px; margin:6px 0; font-size:16px; border-radius:8px; border:1px solid #ccc; }
.btn { padding:10px 15px; border:none; border-radius:8px; cursor:pointer; font-size:15px; }
.btn:disabled { opacity:.6; cursor:not-allowed; }
.btn-start { background:#28a745; color:white; }
.btn-end { background:#dc3545; color:white; }
.btn-cancel { background:#ffc107; color:#000; }
.btn-danger { background:#ff4d4d; color:#fff; }
.btn-group { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 6px; }
.trip-card { background:white; padding:10px 12px; margin:8px 0; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.08); font-size:14px; display:flex; gap:10px; align-items:center; position:relative; transition:background .25s,border .25s; }
.trip-card .content { flex:1; }
.current { background:#e6f2ff; border:2px solid #007bff; }
.hidden { display:none; }
#toast{visibility:hidden; min-width:250px; background:#333; color:#fff; text-align:center; border-radius:8px; padding:12px; position:fixed; left:50%; bottom:30px; transform:translateX(-50%); font-size:16px; opacity:0; transition:opacity .4s,bottom .4s; z-index:1000}
#toast.show{visibility:visible; opacity:1; bottom:50px}
#splash { position:fixed; inset:0; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:22px; z-index:2000; }
#splash img { width:84px; margin-bottom:14px; }
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px;vertical-align:middle}
.online{background:#28a745}.offline{background:#dc3545}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <img src="https://img.icons8.com/color/96/000000/pharmacy-shop.png" alt="logo"/>
  <div>Ø£Ù‡Ù„Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§ÙˆÙŠØ± ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚Ø§</div>
</div>

<!-- Login -->
<div id="loginScreen" class="container hidden">
  <h3 style="text-align:center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
  <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
  <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
  <button id="loginBtn" class="btn btn-start" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- App -->
<div id="app" class="hidden">
  <header>
    Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø§ÙˆÙŠØ± ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ø³Ù‚Ø§
    <div id="date"></div>
    <div style="position:absolute;top:10px;left:10px;font-size:12px">
      <span id="netDot" class="status-dot offline"></span><span id="netText">Ø£ÙˆÙÙ„Ø§ÙŠÙ†</span>
    </div>
    <button id="logoutBtn" class="btn btn-danger" style="position:absolute;right:10px;top:10px">Ø®Ø±ÙˆØ¬</button>
  </header>

  <div class="container">
    <input type="text" id="repName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨" disabled>
    <input type="text" id="destination" placeholder="Ø§Ù„ÙˆØ¬Ù‡Ø©">

    <div class="btn-group">
      <button id="startBtn" class="btn btn-start">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</button>
      <button id="endBtn" class="btn btn-end">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</button>
      <button id="cancelBtn" class="btn btn-cancel">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±</button>
    </div>

    <h3 style="margin:12px 0 6px">Ø§Ù„Ù…Ø´ÙˆØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
    <div id="currentTrip"></div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

// Firebase
const firebaseConfig = {
  apiKey:"AIzaSyCuCRsXNu4hXJtS_rXZmaazbGEz8XhV4PI",
  authDomain:"elsaka-data-pharmacy.firebaseapp.com",
  databaseURL:"https://elsaka-data-pharmacy-default-rtdb.firebaseio.com/",
  projectId:"elsaka-data-pharmacy",
  storageBucket:"elsaka-data-pharmacy.firebasestorage.app",
  messagingSenderId:"182478040389",
  appId:"1:182478040389:web:20a314996f3a256043622c"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// Helpers
const $ = s=>document.querySelector(s);
const toast = m=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),3000); };
const fmtTime = d => new Date(d).toLocaleTimeString("ar-EG");
const durStr = s=>`${Math.floor(s/60)} Ø¯Ù‚ÙŠÙ‚Ø© ${s%60} Ø«Ø§Ù†ÙŠØ©`;
$("#date").textContent = `${new Date().getMonth()+1}/${new Date().getDate()}`;

// Local
let mirror={current:null}, timer=null, endInFlight=false;

// Splash
window.addEventListener("DOMContentLoaded",()=>{
  setTimeout(()=>{ $("#splash").style.display="none"; checkAuth(); },1500);
});

// Network status
function updateNetUI(){
  const online = navigator.onLine;
  $("#netDot").classList.toggle("online",online);
  $("#netDot").classList.toggle("offline",!online);
  $("#netText").textContent = online ? "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" : "Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
}
window.addEventListener("online", updateNetUI);
window.addEventListener("offline", updateNetUI);
updateNetUI();

// Auth
function checkAuth(){
  try{
    onAuthStateChanged(auth,user=>{
      if(user){
        $("#loginScreen").classList.add("hidden");
        $("#app").classList.remove("hidden");
        $("#repName").value = user.email;
        startListeners(user.uid);
      } else {
        $("#loginScreen").classList.remove("hidden");
        $("#app").classList.add("hidden");
      }
    });
  }catch(e){ console.error("Auth error",e); toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"); }
}

// Login
$("#loginBtn").onclick=()=>{
  const email=$("#loginEmail").value.trim();
  const pass=$("#loginPass").value.trim();
  if(!email||!pass){ alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"); return; }
  signInWithEmailAndPassword(auth,email,pass)
    .then(()=>toast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"))
    .catch(e=>alert("Ø®Ø·Ø£: "+e.message));
}

// Logout
$("#logoutBtn").onclick = () => {
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")){
    signOut(auth).then(()=> { toast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"); location.reload(); })
    .catch(e=>alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: "+e.message));
  }
}

// Database listener
function startListeners(uid){
  onValue(ref(db,"currentTrip"), snap=>{
    const val = snap.val();
    mirror.current = (val && val.delegateUid===uid)?val:null;
    renderCurrent();
  });
}

// Render current trip
function renderCurrent(){
  const host=$("#currentTrip"); host.innerHTML=""; if(timer){ clearInterval(timer); timer=null; }
  if(!mirror.current) return;
  const start=new Date(mirror.current.startTime);
  const card=document.createElement("div"); card.className="trip-card current";
  card.innerHTML=`<div class="content">
    <div><strong>${mirror.current.delegateName}</strong> â€” ${mirror.current.destination}</div>
    <div>â±ï¸ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${fmtTime(start)}</div>
    <div id="currentDuration">Ø§Ù„Ù…Ø¯Ø©: 0 Ø¯Ù‚ÙŠÙ‚Ø© 0 Ø«Ø§Ù†ÙŠØ©</div>
  </div>`; host.appendChild(card);
  timer=setInterval(()=>{
    const s=Math.floor((Date.now()-new Date(mirror.current.startTime).getTime())/1000);
    const el=$("#currentDuration"); if(el) el.textContent=`Ø§Ù„Ù…Ø¯Ø©: ${durStr(s)}`;
  },1000);
}

// Start trip
$("#startBtn").onclick = async ()=>{
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±ØŸ")) return;
  const dest=$("#destination").value.trim();
  if(!dest){ alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø©"); return; }
  if(mirror.current){ alert("Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙˆØ§Ø± Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„"); return; }
  const user = auth.currentUser;
  const payload={ currentId:Date.now(), delegateName:user.email, delegateUid:user.uid, destination:dest, startTime:new Date().toISOString() };
  await set(ref(db,"currentTrip"),payload);
  $("#destination").value="";
  toast("âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±");
};

// End trip
$("#endBtn").onclick = async ()=>{
  if(!mirror.current){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ÙˆØ§Ø± Ø¬Ø§Ø±ÙŠ"); return; }
  if(endInFlight) return;
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±ØŸ")) return;
  endInFlight=true; $("#endBtn").disabled=true;
  try{
    const updates={};
    const tripId = mirror.current.currentId;
    updates[`/trips/${tripId}`]={...mirror.current, endTime:new Date().toISOString()};
    updates["/currentTrip"]=null;
    await update(ref(db),updates);
    toast("ğŸ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±");
  }finally{ endInFlight=false; $("#endBtn").disabled=false; }
};

// Cancel trip
$("#cancelBtn").onclick = async ()=>{
  if(!mirror.current){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ÙˆØ§Ø± Ø¬Ø§Ø±ÙŠ"); return; }
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±ØŸ")) return;
  await set(ref(db,"currentTrip"),null);
  toast("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´ÙˆØ§Ø±");
};
</script>
</body>
</html>